# BOLT #1: 基本プロトコル

## 概要

このプロトコルでは、個別メッセージのフレーミングを処理する基本的な認証及び順序付けされたトランスポートメカニズムを前提にしています。
[BOLT #8](08-transport.md)はLightningで使用される標準的なトランスポート層を指定していますが、上記を満たす任意のトランスポート層に置き換えることが可能です。

デフォルトのTCPポートは9735です。これはLIGHTNINGのUnicodeのコードポイントである16進の`0x2607`に対応しています。<sup>[1](#著者-1)</sup>

明記されていない限り、全てのデータフィールドはビッグエンディアンです。

## 目次
  * [Lightningメッセージフォーマット](#Lightningメッセージフォーマット)
  * [セットアップメッセージ](#セットアップメッセージ)
    * [`init`メッセージ](#initメッセージ)
    * [`error`メッセージ](#errorメッセージ)
  * [謝辞](#謝辞)
  * [参照](#参照)
  * [著者](#著者)

## Lightningメッセージフォーマット

復号化後の全てのlightningメッセージは以下のフォーマットです。

1. `type`: 2バイトのビッグエンディアンのフィールドで、メッセージのタイプを示します。
2. `payload`: 可変長のペイロードです。メッセージの残りの部分で、タイプに一致するフォーマットが適用されます。

`type`フィールドは`payload`フィールドの解釈の方法を示します。
個々のタイプのフォーマットは、このリポジトリの仕様で指定されています。
タイプは_it's ok to be odd_ルールに従います。ノードは受信側がそれを理解しているか確認せずに奇数番号のタイプを送るかもしれません。
ノードは事前のネゴシエーションなしに、ここに挙げられていないevenly-typedメッセージを送信してはなりません。
タイプが奇数の場合、未知のタイプの受信メッセージは無視しなければなりません。
タイプが偶数の場合に未知のタイプのメッセージをしたら、ノードはチャネルに失敗しなければなりません。

メッセージは論理的に４つのグループにグルーピングされます。

- セットアップとシグナリング（タイプ `0`-`31`）: サポートされているフィーチャーとエラー報告に関連したメッセージ。詳細については以下で説明します。
- チャネル（タイプ`32`-`127`）: マイクロペイメントチャネルのセットアップ及び終了させるために使用されるメッセージで、詳細は[BOLT #2](02-peer-protocol.md)に記載されています。
- コミットメント（タイプ`128`-`255`）: （手数料の更新や署名の交換、追加、取消、HTLCsの決済など）コミットメントトランザクションの更新に関するメッセージです。詳細は[BOLT #2](02-peer-protocol.md)に記載されています。
- ルーティング（タイプ`256`-`511`）: ノードやチャネルの通知及びアクティブなルート探索のメッセージです。詳細は[BOLT #7](07-routing-gossip.md)に記載されています。

メッセージのサイズはトランスポート層によって2バイトの符号無し整数に収まる必要があるため、最大サイズは65,535バイトです。
ノードは、メッセージ内のデータに関してタイプ毎に予期されている長さより大きいデータについては無視しなければなりません。
ノードは、コンテンツの長さが不十分なメッセージを受信した場合、チャネルに失敗しなければなりません。

### 論理的根拠

`SHA2`の標準的なエンディアンやBitcoinの公開鍵のエンコーディングはビッグエンディアンであるため、
他のフィールドに異なるエンディアンを使用するのは普通ではありません。

メッセージの長さは暗号化された状態で65,535バイトに制限されており、
プロトコルのメッセージは決してその長さを超えることはありません。

"it's OK to be odd"ルールは、クライアントでのネゴシエーションや特別なコーディングを必要とせず、将来の拡張を可能にします。
"ignore additional data"ルールも同様に将来の拡張を可能にします。

実装では、メッセージデータを8バイトに区切ることが望ましい場合がありますが、
タイプフィールドの後に6バイトのパディングを追加することは無駄であると考え、
6バイトのプレパディングを持つバッファに復号化したメッセージを入れて解釈します。

## セットアップメッセージ

### `init`メッセージ

認証が完了すると、再接続の場合でも、最初のメッセージでこのノードがサポートまたは必要とするフィーチャーを明らかにします。
必須のフィーチャーであっても、奇数のフィーチャーはオプションです (_it's OK to be odd_)。
これらのビットの意味は将来定義されます。

1. type: 16 (`init`)
2. data:
   * [2:gflen]
   * [gflen:globalfeatures]
   * [2:lflen]
   * [lflen:localfeatures]

2バイトの`gflen`と`lflen`のフィールドは、その後のフィールドのバイト数を示します。

#### 要件

送信ノードはあらゆる接続の最初のlightningメッセージとして`init`を送信しなければなりません。
送信ノードはフィーチャーフィールドを表すために必要な最小の長さを使用すべきです。
送信ノードはピアがサポートする必要があるフィーチャーに対応するフィーチャービットをセットしなければならず、
またオプションでサポートするフィーチャーに対応するフィーチャービットをセットする必要があります。

受信ノードは、自身が理解できない偶数ビットを持つ`globalfeatures`もしくは`localfeatures`を受信した場合、
チャネルに失敗しなければなりません。

各ノードは他のメッセージを送る前に必ず`init`メッセージの受信を待つ必要があります。

#### 論理的根拠

偶数/奇数のセマンティックは将来の互換性のない変更、または後方互換製のある変更を可能にします。
ビットは一般的にペアで割り当てられるため、オプションのフィーチャーを後に必須にすることも可能です。

ノードは、フィーチャーの互換性がないか簡易的なエラー診断をするため、他のフィーチャーの受信を待ちます。

フィーチャーは、２つのノード間のプロトコルにのみ影響するローカルフィーチャーと、
HTLCsに影響するすなわち他のノードにも影響するグローバルフィーチャーに分かれます。

### `error`メッセージ

診断を簡単にするために、何かが間違っていることをピアに伝えることは有用です。

1. type: 17 (`error`)
2. data:
   * [8:channel-id]
   * [2:len]
   * [len:data]

2バイトの`len`フィールドは、その後のフィールドのバイト数を示します。

#### 要件

ノードはプロトコルの違反や、チャネルを使用不能にしたり、それ以上の通信ができなくなる内部エラーに対してエラーを送信すべきです。
ノードは空の[data]フィールドを送るかもしれません。
`error`を送信するノードは`channel-id`によって参照されているチャネルに失敗しなければならず、
もし`channel-id`が`0xFFFFFFFFFFFFFFFF`の場合は全てのチャネルに失敗し、接続を閉じなければなりません。
ノードは`data`の長さと同じ`len`をセットしなければなりません。
ノードは無効な署名による署名の検証に失敗した場合、`funding_created`, `funding_signed`, `closing_signed`, `commitment_signed`メッセージへの
応答に、16進エンコードしたトランザクションのrawデータを含めるべきです。

`error`を受信するノードは`channel-id`によって参照されているチャネルに失敗しなければならず、
もし`channel-id`が`0xFFFFFFFFFFFFFFFF`の場合は全てのチャネルに失敗し、接続を閉じなければなりません。
受信ノードは`len`より長いデータがあれば、超過している残りのパケットをtruncateしなければなりません。

受信ノードは、文字列が印刷可能なASCII文字のみで構成されている場合のみ、そのまま`data`を印字すべきです。
参考のため、印刷可能な文字セットは32から127のバイト値が含まれています。

#### 論理的根拠

会話の中止が必要な回復不可能なエラーがあります。
単に接続が切れた場合は、ピアは再接続を行います。
あるピアにバグがあることを示すのに、診断のためプロトコル違反を記述するのは便利です。

情報が漏洩するといけないので、プロダクションの設定でエラーを識別しない方がいいかもしれません。

## 謝辞

TODO(roasbeef); fin


## 参照
1. <a id="reference-2">http://www.unicode.org/charts/PDF/U2600.pdf</a>

## 著者

FIXME

![Creative Commons License](https://i.creativecommons.org/l/by/4.0/88x31.png "License CC-BY")
<br>
この仕様は [Creative Commons Attribution 4.0 International License](http://creativecommons.org/licenses/by/4.0/)のライセンス下にあります。
